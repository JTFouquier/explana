---
title: "Feature Selection Report"
date: "`r Sys.Date()`"
params:
   rmd: "report.Rmd"
output:
  html_document
---

```{r setup, include=FALSE}
source("scripts/install.R")
package_list <- c("knitr", "htmltools", "tidyverse", "Hmisc")
install_r_packages(package_list = package_list)
library(knitr)
library(htmltools)
library(tidyverse)
library(Hmisc)
knitr::opts_chunk$set(echo = FALSE,
                      eval = TRUE)
source("scripts/feature-heatmaps.R")
```
***

#

<h1 style="background-color:lightgray; color: black; text-align: center; padding-top:30px; padding-bottom: 30px; padding-left: 20px;">Summary</h1>

```{r comment="", echo = FALSE}

response_var <- snakemake@config[["response_var"]]
drop_cols <- snakemake@config[["drop_cols"]]
constrain_rows <- snakemake@config[["constrain_rows"]]
random_effect <- snakemake@config[["random_effect"]]
drop_rows <- snakemake@config[["drop_rows"]]
iterations <- snakemake@config[["iterations"]]
n_estimators <- snakemake@config[["n_estimators"]]
enc_percent_threshold <- snakemake@config[["enc_percent_threshold"]]

out_path <- snakemake@config[["out"]]
original_path <- paste0(out_path, snakemake@config[["path_rf_original"]])
first_path <- paste0(out_path, snakemake@config[["path_rf_first"]])
previous_path <- paste0(out_path, snakemake@config[["path_rf_previous"]])
pairwise_path <- paste0(out_path, snakemake@config[["path_rf_pairwise"]])

wd <- paste0(getwd(), "/")
wd_analysis <- paste0(wd, out_path)
wd_original <- paste0(wd, original_path)
wd_first <- paste0(wd, first_path)
wd_previous <- paste0(wd, previous_path)
wd_pairwise <- paste0(wd, pairwise_path)
```

***

#### Inputs and Analysis Arguments

**Response variable:** `r response_var`

**Random effect:** `r random_effect`

**Features dropped:** `r toString(drop_cols)`

**Values dropped (feature & value):** `r toString(drop_rows)`

**Constrained to rows:** `r toString(constrain_rows)`

**Analysis notes:** `r toString(snakemake@config[["analysis_notes"]])`

***

#### Summary of methods

This workflow (name needed!) was used to identify important features 
predictive of the response variable, **``r response_var``**.

A random effect of **``r random_effect``** was used to adjust for 
non-independence (repeated measurements) as needed. There were 
**``r n_estimators` trees`** used per Random Forest model. If mixed 
effects Random Forests were needed, **``r iterations` iterations`** 
were performed. Categorical variables were encoded (expand) and 
low occurring values were removed if found in less than 
**``r enc_percent_threshold`%`** of samples. 

Values of the response variable, **``r response_var``**, are 
explained best with the important features selected using this 
workflow.

Please ensure you understand the workflow and that the accuracy 
of the model is adequate for your purposes. When you are using 
all your data without prior hypotheses, you are performing 
*exploratory analysis* and should make this clear
when discussing results.

Additional figures and files can be found in output directory.

***

#### Directory Links

[⇨ Full Analysis Directory](file://`r wd_analysis`){target="_blank"}

[⇨ Original Dataset    |  ](file://`r wd_original`){target="_blank"}
[⇨ First Delta Dataset    |  ](file://`r wd_first`){target="_blank"}
[⇨ Previous Delta Dataset    |  ](file://`r wd_previous`){target="_blank"}
[⇨ Pairwise Delta Dataset](file://`r wd_pairwise`){target="_blank"}

***

```{r include = FALSE }

plot_pattern_display <- function(path_name, pattern, grep_arg) {
  files <- list.files(path = path_name, pattern = pattern)
  my_plots <- grep(grep_arg, files, value = TRUE)

  # get files with pattern and grep argument
  for (f in my_plots) {
      cat("\n\n")
      cat(paste0("![](", path_name, f, ")"), "\n")
  }
}

# create the plot to show which datasets important features
# were occurring in (done now after building all models)
make_feature_heatmaps(out_path)
```

#

### Important Feature Occurences by Dataset

This workflow is designed to assist with understanding 
original feature values, as well as changes in feature 
values, when compared to various reference points. 
Certain features may carry varying degrees of importance 
across different datasets and this workflow helps 
identify these discrepancies.

```{r out.width = 1100, out.height = 700, comment=""}
include_graphics(paste0(out_path, "important-feature-occurrences.svg"))
```

#

***

<h1 style="background-color:#FFFACD; color: black; text-align: center; padding-top:30px; padding-bottom: 30px; padding-left: 20px;">Original Dataset</h1>

***

## Results {.tabset}

### Log and SHAP Summary Results

[⇨ Open Original Dataset Directory](file://`r wd_original`){target="_blank"}

```{r comment=""}
cat(readLines(snakemake@input[["original_log"]]), sep = "\n")
```


```{r results="asis", comment=""}
plot_pattern_display(path_name = original_path, pattern = ".svg",
                     grep_arg = "SHAP-summary-beeswarm")
```

### BorutaSHAP Important Features

```{r results="asis", comment=""}
plot_pattern_display(path_name = original_path, pattern = ".svg",
                     grep_arg = "boruta-accepted")
```

### Results PDF

[⇨ Open PDF in new window](file://`r wd_original`original.pdf){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
include_graphics(paste0(original_path, "original.pdf"))
```

#
***

<h1 style="background-color:cornflowerblue; color: black; text-align: center; padding-top:30px; padding-bottom: 30px; padding-left: 20px;">First Delta Dataset</h1>

## Results {.tabset}

### Log and SHAP Summary Results

[⇨ Open First Delta Dataset Directory](file://`r wd_first`){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
cat(readLines(snakemake@input[["first_log"]]), sep = "\n")
```

```{r results="asis", comment=""}
plot_pattern_display(path_name = first_path, pattern = ".svg",
                     grep_arg = "SHAP-summary-beeswarm")
```

### BorutaSHAP Important Features

```{r results="asis", comment=""}
plot_pattern_display(path_name = first_path, pattern = ".svg",
                     grep_arg = "boruta-accepted")
```

### Results PDF

[⇨ Open PDF in new window](file://`r wd_first`first.pdf){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
include_graphics(paste0(first_path, "first.pdf"))
```

#
***

<h1 style="background-color:lightgreen; color: black; text-align: center; padding-top:30px; padding-bottom: 30px; padding-left: 20px;">Previous Delta Dataset</h1>

## Results {.tabset}

### Log and SHAP Summary Results

[⇨ Open Previous Delta Dataset Directory](file://`r wd_previous`){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
cat(readLines(snakemake@input[["previous_log"]]), sep = "\n")
```

```{r results="asis", comment=""}
plot_pattern_display(path_name = previous_path, pattern = ".svg",
                     grep_arg = "SHAP-summary-beeswarm")
```

### BorutaSHAP Important Features

```{r results="asis", comment=""}
plot_pattern_display(path_name = previous_path, pattern = ".svg",
                     grep_arg = "boruta-accepted")
```

### Results PDF

[⇨ Open PDF in new window](file://`r wd_previous`previous.pdf){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
include_graphics(paste0(previous_path, "previous.pdf"))
```

#
***

<h1 style="background-color:#AB82FF; color: black; text-align: center; padding-top:30px; padding-bottom: 30px; padding-left: 20px;">Pairwise Delta Dataset</h1>

## Results {.tabset}

### Log and SHAP Summary Results

[⇨ Open Pairwise Delta Dataset Directory](file://`r wd_pairwise`){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
cat(readLines(snakemake@input[["pairwise_log"]]), sep = "\n")
```

```{r results="asis", comment=""}
plot_pattern_display(path_name = pairwise_path, pattern = ".svg",
                     grep_arg = "SHAP-summary-beeswarm")
```

### BorutaSHAP Important Features

```{r results="asis", comment=""}
plot_pattern_display(path_name = pairwise_path, pattern = ".svg",
                     grep_arg = "boruta-accepted")
```

### Results PDF

[⇨ Open PDF in new window](file://`r wd_pairwise`pairwise.pdf){target="_blank"}

```{r out.width = 1100, out.height = 600, comment=""}
include_graphics(paste0(pairwise_path, "pairwise.pdf"))
```

#

***

#

<h1 style="background-color:lightgray; color: black; text-align: center; padding-top:30px; padding-bottom: 30px; padding-left: 20px;">Post-hoc tests</h1>

# Results {.tabset}

***

## Description

Linear models or linear mixed effects models were used for post hoc testing to determine if a linear relationship exists between selected feature and response variable.

## Results

```{r out.width = 1100, out.height = 600, comment=""}
# htmltools::includeHTML(snakemake@input[["post_hoc"]])
```

## Graphs

```{r out.width = 1100, out.height = 600, comment=""}
# include_graphics(paste0(snakemake@config[["post_hoc_viz"]],
# "post-hoc-combined.pdf"))
```


***

See the [Github repository](https://github.com/JTFouquier/snakemake-MERF "Still a work in progress!! :) ") for more information.

***

```{r}
# read in a table example
# df = read.csv(snakemake@input[["table_boruta"]], sep = "\t")
# knitr::kable(df$important.features, format = "html")
```

<a download="report.Rmd" href="`r base64enc::dataURI(file = params$rmd, mime="text/rmd", encoding="base64")`">Click here for R Markdown source file</a>

